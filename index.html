<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ù„Ø¹Ø¬Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ© â€” ØªÙˆØ²ÙŠØ¹ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¹Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</title>
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0f172a; /* slate-900 */
      --bg2:#1f2937; /* gray-800 */
      --acc:#22d3ee; /* cyan-400 */
      --acc2:#a78bfa; /* violet-400 */
      --success:#22c55e;
      --danger:#ef4444;
      --card:#0b1024cc;
      --glass:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Cairo',system-ui,Segoe UI; color:#fff; overflow-x:hidden;
      background: radial-gradient(1200px 800px at 10% 10%, #111827 0%, #0b132b 40%, #090a12 100%),
                  url('https://images.unsplash.com/photo-1516387938699-a93567ec168e?q=80&w=1200&auto=format&fit=crop') center/cover fixed;
    }
    .overlay{position:fixed; inset:0; backdrop-filter:blur(6px); background:linear-gradient(135deg, #0b1024e6 0%, #0b1024aa 60%, #0b102466 100%);}

    .container{position:relative; max-width:1100px; margin:0 auto; padding:20px;}

    header{display:flex; align-items:center; justify-content:space-between; gap:16px; padding-top:8px}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:40px; height:40px; border-radius:14px; background:linear-gradient(135deg,var(--acc),var(--acc2)); box-shadow:0 10px 30px #0008}
    h1{margin:0; font-size:clamp(20px,3vw,28px)}
    .nav{display:flex; gap:10px}
    .btn{cursor:pointer; border:0; padding:10px 16px; border-radius:14px; font-weight:700; color:#111; background:linear-gradient(135deg,#fff,#dbeafe); box-shadow:inset 0 0 0 1px #ffffff33, 0 10px 30px #0006; transition:.2s}
    .btn.alt{color:#fff; background:linear-gradient(135deg,var(--acc2),var(--acc));}
    .btn.ghost{background:transparent; color:#fff; border:1px solid #ffffff33}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    .grid{display:grid; grid-template-columns:1.1fr .9fr; gap:22px; margin-top:24px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr;}}

    .card{background:var(--card); border:1px solid #ffffff22; border-radius:22px; padding:18px; box-shadow:0 20px 50px #0008}
    .card h2{margin:0 0 12px 0; font-size:22px}

    /* Form */
    form .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    form .row + .row{margin-top:12px}
    form input, form select{width:100%; padding:12px 14px; border-radius:12px; border:1px solid #3b3b4f; background:#0e132c; color:#fff; outline:none}
    .helper{font-size:13px; opacity:.8}

    /* Wheel */
    .wheel-wrap{position:relative; display:flex; align-items:center; justify-content:center; aspect-ratio:1/1; width:min(540px, 95vw); margin:0 auto}
    canvas#wheel{width:100%; height:100%; background: radial-gradient(circle at 30% 30%, #0e1a3a, #0a0f24 60%); border-radius:50%; border:2px solid #ffffff22; box-shadow:inset 0 0 60px #0008, 0 20px 60px #0008}
    .pointer{position:absolute; top:-6px; left:50%; translate:-50% 0; width:0; height:0; border-left:14px solid transparent; border-right:14px solid transparent; border-bottom:24px solid var(--acc); filter:drop-shadow(0 6px 10px #000a)}
    .spin-btn{position:absolute; inset:auto auto 18px 50%; translate:-50% 0}

    /* Result + alerts */
    .result{margin-top:10px; font-weight:800; font-size:18px}
    .alert{padding:12px 14px; border-radius:12px; margin-top:10px; display:none}
    .alert.show{display:block}
    .alert.ok{background:#052e1b; border:1px solid #22c55e33}
    .alert.bad{background:#3b0a0a; border:1px solid #ef444433}

    /* Admin */
    .admin{margin-top:26px}
    .admin .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    table{width:100%; border-collapse:collapse; margin-top:12px; background:#0d1433; border-radius:12px; overflow:hidden}
    th, td{padding:10px 12px; border-bottom:1px solid #ffffff10; text-align:center}
    th{background:#0a1027; font-weight:800}
    tr:last-child td{border-bottom:0}
    .pill{padding:4px 10px; border-radius:999px; background:#111a3b; border:1px solid #ffffff22; font-size:12px}
    .muted{opacity:.75}

    footer{margin:28px 0 10px; text-align:center; opacity:.8; font-size:13px}
    code.inline{background:#0e132c; padding:2px 6px; border-radius:6px}
  </style>
</head>
<body>
  <div class="overlay"></div>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <h1>Ø§Ù„Ø¹Ø¬Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ© â€” ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</h1>
      </div>
      <nav class="nav">
        <button class="btn ghost" id="show-user">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
        <button class="btn alt" id="show-admin">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
      </nav>
    </header>

    <div class="grid" id="user-side">
      <section class="card">
        <h2>Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</h2>
        <form id="user-form">
          <div class="row">
            <input id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" required />
            <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required />
          </div>
          <div class="row">
            <select id="gender" required>
              <option value="">Ø§Ù„Ù†ÙˆØ¹</option>
              <option value="boy">ÙˆÙ„Ø¯</option>
              <option value="girl">Ø¨Ù†Øª</option>
            </select>
            <button type="submit" class="btn" id="start-spin">Ø³Ø¬Ù‘Ù„ ÙˆØ¯ÙˆÙ‘Ø± Ø§Ù„Ø¹Ø¬Ù„Ø© ğŸ¯</button>
          </div>
          <div class="helper">* Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙØ±ÙŠØ¯ â€” Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù… Ù…Ø±ØªÙŠÙ†.</div>
        </form>
        <div class="alert bad" id="err"></div>
        <div class="alert ok" id="ok"></div>
      </section>

      <section class="card">
        <h2>Ø§Ù„Ø¹Ø¬Ù„Ø©</h2>
        <div class="wheel-wrap">
          <div class="pointer"></div>
          <canvas id="wheel" width="600" height="600"></canvas>
          <button class="btn spin-btn" id="spin-again" disabled>Ø¯ÙˆÙ‘Ø± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
        </div>
        <div class="result" id="result"></div>
        <div class="helper muted">* Ø§Ù„Ø¹Ø¬Ù„Ø© ØªØ®ØªØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© ÙÙ‚Ø·.</div>
      </section>
    </div>

    <section class="card admin" id="admin-side" style="display:none">
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
      <div class="toolbar">
        <input id="admin-pass" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©" />
        <button class="btn" id="admin-login">Ø¯Ø®ÙˆÙ„</button>
        <span class="pill muted">ØªÙ†Ø¨ÙŠÙ‡: ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‡Ù†Ø§ Ù„ÙŠØ³Øª Ø­Ù…Ø§ÙŠØ© Ù‚ÙˆÙŠØ© â€” Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø³ÙŠØ· ÙÙ‚Ø·.</span>
      </div>
      <div id="admin-panels" style="display:none">
        <div style="margin-top:14px" class="toolbar">
          <input id="g-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©" />
          <input id="g-cap" type="number" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰" />
          <button class="btn" id="g-add">Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
        </div>

        <table id="groups-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
              <th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰</th>
              <th>Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†</th>
              <th>Ù…ØªØ¨Ù‚ÙŠ</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <h3 style="margin-top:16px">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø´Ø®Ø§Øµ</h3>
        <table id="users-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
              <th>Ø§Ù„Ù†ÙˆØ¹</th>
              <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <footer>ØµÙÙ…Ù… Ù„ÙŠØ´Ø¬Ø¹ Ø´Ø¨Ø§Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ â€” Ø£Ù„ÙˆØ§Ù†ØŒ Ø¬Ù„ÙŠØªØ´ Ø¨Ø³ÙŠØ·ØŒ ÙˆØ®Ù„ÙÙŠØ© Ù…Ù„Ù‡Ù…Ø©. âœ¨</footer>
  </div>

  <!-- ========================================= -->
  <!-- ğŸ§°  Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase: ØºÙŠÙ‘Ø± Ø§Ù„Ù‚ÙŠÙ… Ø£Ø¯Ù†Ø§Ù‡     -->
  <!-- ========================================= -->
  <script>
    const SUPABASE_URL = 'https://uvrtdlhidvcbtneljwow.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2cnRkbGhpZHZjYnRuZWxqd293Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDQ2MDMsImV4cCI6MjA3MDgyMDYwM30.7f36ccptnIlVKxtO6E_i3DUyuCBSxeJkUrtTJkTd9-g';

    // Ø¥Ø³Ù… Ø§Ù„Ø¯Ø§Ù„Ø©/Ø§Ù„Ù€ RPC Ø§Ù„Ù…Ø¹Ø±Ù‘ÙØ© ÙÙŠ SQL Ø£Ø¯Ù†Ø§Ù‡
    const FN_ASSIGN = 'assign_user_to_group';
    const FN_ADMIN_ADD = 'admin_add_group';
    const FN_ADMIN_UPDATE = 'admin_update_group';
    const FN_ADMIN_DELETE = 'admin_delete_group';
    const FN_ADMIN_LIST = 'admin_list_overview';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- ============================= -->
  <!-- ğŸ¡  ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø¬Ù„Ø© + ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
  <!-- ============================= -->
  <script>
    const userSide = document.getElementById('user-side');
    const adminSide = document.getElementById('admin-side');
    document.getElementById('show-user').onclick = () => { userSide.style.display='grid'; adminSide.style.display='none'; };
    document.getElementById('show-admin').onclick = () => { userSide.style.display='none'; adminSide.style.display='block'; };

    const wheelCanvas = document.getElementById('wheel');
    const ctx = wheelCanvas.getContext('2d');
    let segments = []; // [{id,name,capacity,filled}]
    let selectedSegmentIndex = null;

    function drawWheel(highlightIndex=null){
      const W = wheelCanvas.width, H = wheelCanvas.height;
      ctx.clearRect(0,0,W,H);
      const cx=W/2, cy=H/2, r=W/2 - 6;
      const n = segments.length || 1;
      for(let i=0;i<n;i++){
        const start = (i/n)*2*Math.PI - Math.PI/2;
        const end   = ((i+1)/n)*2*Math.PI - Math.PI/2;
        // Ù„ÙˆÙ† Ù…ØªØ¯Ø±Ø¬ Ø­ÙŠÙˆÙŠ
        const grd = ctx.createLinearGradient(cx,cy, cx+r*Math.cos(start), cy+r*Math.sin(start));
        const hue = Math.floor(360*(i/n));
        grd.addColorStop(0, `hsl(${hue}, 80%, 55%)`);
        grd.addColorStop(1, `hsl(${(hue+40)%360}, 80%, 45%)`);
        ctx.beginPath();
        ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,end); ctx.closePath();
        ctx.fillStyle=grd; ctx.fill();
        // Ø­Ø§ÙØ©
        ctx.strokeStyle = '#00000055'; ctx.lineWidth=2; ctx.stroke();
        // Ù†Øµ
        ctx.save();
        ctx.translate(cx,cy); ctx.rotate((start+end)/2);
        ctx.textAlign='center'; ctx.fillStyle='#fff'; ctx.font='700 18px Cairo';
        ctx.fillText(segments[i]?.name || 'â€¦', r*0.62, 6);
        ctx.restore();
      }
      // Ø¯Ø§Ø¦Ø±Ø© ÙˆØ³Ø·
      ctx.beginPath(); ctx.arc(W/2,H/2,36,0,2*Math.PI); ctx.fillStyle='#0b1024'; ctx.fill();
      ctx.strokeStyle='#ffffff55'; ctx.stroke();

      if(highlightIndex!=null){
        // Ù„Ù…Ø¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„ÙØ§Ø¦Ø²
        const i = highlightIndex, n=segments.length;
        const start = (i/n)*2*Math.PI - Math.PI/2;
        const end   = ((i+1)/n)*2*Math.PI - Math.PI/2;
        ctx.beginPath(); ctx.moveTo(W/2,H/2); ctx.arc(W/2,H/2,r,start,end); ctx.closePath();
        ctx.fillStyle='rgba(255,255,255,.12)'; ctx.fill();
      }
    }

    async function loadSegments(){
      // Ù†Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø¹ Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†
      const { data, error } = await supabase
        .from('groups_with_counts') // View Ù…Ø±ÙŠØ­Ø© Ù†Ù†Ø´Ø¦Ù‡Ø§ ÙÙŠ SQL
        .select('*')
        .order('name');
      if(error){ console.error(error); return; }
      segments = data.map(g=>({ id:g.id, name:g.name, capacity:g.capacity, filled:g.member_count }));
      drawWheel();
    }

    // Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø¹Ø¬Ù„Ø© Ù„ÙŠÙ‚Ù Ø¹Ù„Ù‰ index Ù…Ø¹ÙŠÙ†
    function spinTo(index){
      return new Promise(resolve=>{
        const n = segments.length;
        const baseRot = 360*5; // Ù„Ù„ÙØ§Øª Ù…Ù…ØªØ¹Ø©
        const segmentAngle = 360/n;
        const targetAngleCenter = (index+0.5)*segmentAngle; // Ù…Ù† Ø£Ø¹Ù„Ù‰ (Ø§Ù„Ø³Ù‡Ù… Ù„Ù„Ø£Ø¹Ù„Ù‰)
        // ØªØ­ÙˆÙŠÙ„ Ù„ÙƒÙŠ ÙŠÙ‚Ù Ù…Ø¤Ø´Ø± Ø§Ù„Ø³Ù‡Ù… Ø¹Ù†Ø¯ Ù…Ù†ØªØµÙ Ø§Ù„Ù‚Ø·Ø§Ø¹
        const finalRotation = baseRot + (360 - targetAngleCenter);
        const el = wheelCanvas;
        el.style.transition = 'transform 4s cubic-bezier(.1,.75,.2,1)';
        el.style.transform = `rotate(${finalRotation}deg)`;
        setTimeout(()=>{
          el.style.transition='';
          const mod = finalRotation % 360;
          el.style.transform = `rotate(${mod}deg)`; // Ø«Ø¨Øª Ù‚ÙŠÙ…Ø© Ø¨Ø³ÙŠØ·Ø©
          resolve();
        }, 4100);
      });
    }

    function showMsg(id, text){
      const el = document.getElementById(id);
      el.textContent = text; el.classList.add('show');
      if(id==='err') document.getElementById('ok').classList.remove('show');
      if(id==='ok') document.getElementById('err').classList.remove('show');
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª + Ø§Ø®ØªÙŠØ§Ø± Ø¢Ù…Ù† Ø¹Ø¨Ø± RPC
    document.getElementById('user-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const gender = document.getElementById('gender').value;
      document.getElementById('start-spin').disabled = true;
      showMsg('err',''); document.getElementById('err').classList.remove('show');
      document.getElementById('ok').classList.remove('show');

      try{
        // ÙŠØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ¶Ù…Ù† Ø§Ù„Ø°Ø±Ù‘Ø© ÙˆÙ…Ù†Ø¹ Ø§Ù„ØªØ¹Ø§Ø±Ø¶
        const { data, error } = await supabase.rpc(FN_ASSIGN, { p_name:name, p_phone:phone, p_gender:gender });
        if(error){
          if(error.message && error.message.includes('phone_exists')){
            showMsg('err','Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ù…Ù† Ù‚Ø¨Ù„.');
          } else if(error.message && error.message.includes('no_available_group')){
            showMsg('err','Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.');
          } else if(error.code === '23505'){ // unique_violation
            showMsg('err','Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ù…Ù† Ù‚Ø¨Ù„.');
          } else {
            showMsg('err','Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.');
          }
          return;
        }
        // Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ±Ø¬Ø¹ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        const chosenGroupName = data?.group_name || data?.[0]?.group_name;
        const idx = segments.findIndex(s=>s.name===chosenGroupName);
        if(idx===-1){ await loadSegments(); }
        const index = segments.findIndex(s=>s.name===chosenGroupName);
        await spinTo(index);
        document.getElementById('result').textContent = `Ù…Ø¨Ø±ÙˆÙƒ! Ù…Ø¬Ù…ÙˆØ¹ØªÙƒ: ${chosenGroupName}`;
        showMsg('ok','ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
        document.getElementById('spin-again').disabled = false;
        await loadSegments();
      } finally {
        document.getElementById('start-spin').disabled = false;
      }
    });

    document.getElementById('spin-again').addEventListener('click', ()=>{
      // Ø¯ÙˆØ±Ø§Ù† Ø´ÙƒÙ„ÙŠ Ø¥Ø¶Ø§ÙÙŠ
      const n = segments.length; if(!n) return; const idx = Math.floor(Math.random()*n);
      spinTo(idx);
    });

    loadSegments();
  </script>

  <!-- ============================= -->
  <!-- ğŸ› ï¸  Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª     -->
  <!-- ============================= -->
  <script>
    let ADMIN_PASS = null;
    const adminPanels = document.getElementById('admin-panels');
    const tbodyGroups = document.querySelector('#groups-table tbody');
    const tbodyUsers = document.querySelector('#users-table tbody');

    document.getElementById('admin-login').onclick = async ()=>{
      ADMIN_PASS = document.getElementById('admin-pass').value;
      if(!ADMIN_PASS){ alert('Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); return; }
      adminPanels.style.display='block';
      await refreshAdmin();
    };

    async function refreshAdmin(){
      // Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª + Ø§Ù„Ø£Ø´Ø®Ø§Øµ (Ø¯Ø§Ù„Ø© Ù…Ø®ØµØµØ© ØªÙØ±Ø¬Ø¹ JSON Ù…Ù†Ø¸Ù‘Ù…)
      const { data, error } = await supabase.rpc(FN_ADMIN_LIST, { p_password: ADMIN_PASS });
      if(error){ alert('ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); adminPanels.style.display='none'; return; }
      const groups = data.groups;
      const users = data.users;

      // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
      tbodyGroups.innerHTML='';
      groups.forEach((g,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td><input data-id="${g.id}" data-field="name" value="${g.name}" style="width:100%; padding:6px 8px; border-radius:8px; border:1px solid #334" /></td>
          <td><input data-id="${g.id}" data-field="capacity" type="number" value="${g.capacity}" style="width:100%; padding:6px 8px; border-radius:8px; border:1px solid #334" /></td>
          <td>${g.member_count}</td>
          <td>${g.capacity - g.member_count}</td>
          <td>
            <button class="btn" data-action="save" data-id="${g.id}">Ø­ÙØ¸</button>
            <button class="btn ghost" data-action="delete" data-id="${g.id}">Ø­Ø°Ù</button>
          </td>`;
        tbodyGroups.appendChild(tr);
      });

      // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø­Ø°Ù
      tbodyGroups.onclick = async (e)=>{
        const action = e.target.getAttribute('data-action');
        const id = e.target.getAttribute('data-id');
        if(!action||!id) return;
        if(action==='delete'){
          if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø³ÙŠØ­Ø°Ù ØªØ³Ø¬ÙŠÙ„Ø§ØªÙ‡Ø§ Ø£ÙŠØ¶Ø§Ù‹ØŸ')) return;
          const { error } = await supabase.rpc(FN_ADMIN_DELETE, { p_password: ADMIN_PASS, p_group_id:id });
          if(error){ alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: '+error.message); return; }
          await refreshAdmin();
        }
        if(action==='save'){
          const name = tbodyGroups.querySelector(`input[data-id="${id}"][data-field="name"]`).value;
          const capacity = parseInt(tbodyGroups.querySelector(`input[data-id="${id}"][data-field="capacity"]`).value||'0',10);
          const { error } = await supabase.rpc(FN_ADMIN_UPDATE, { p_password: ADMIN_PASS, p_group_id:id, p_name:name, p_capacity:capacity });
          if(error){ alert('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: '+error.message); return; }
          await refreshAdmin();
        }
      };

      // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø´Ø®Ø§Øµ
      tbodyUsers.innerHTML='';
      users.forEach((u,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${u.name}</td><td>${u.phone}</td><td>${u.gender==='boy'?'ÙˆÙ„Ø¯':'Ø¨Ù†Øª'}</td><td>${u.group_name}</td>`;
        tbodyUsers.appendChild(tr);
      });
    }

    document.getElementById('g-add').onclick = async ()=>{
      const name = document.getElementById('g-name').value.trim();
      const cap = parseInt(document.getElementById('g-cap').value||'0',10);
      if(!name||!cap){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆØ­Ø¯ Ø£Ù‚ØµÙ‰'); return; }
      const { error } = await supabase.rpc(FN_ADMIN_ADD, { p_password: ADMIN_PASS, p_name:name, p_capacity:cap });
      if(error){ alert('ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: '+error.message); return; }
      document.getElementById('g-name').value=''; document.getElementById('g-cap').value='';
      await refreshAdmin();
    };
  </script>